(window.webpackJsonp=window.webpackJsonp||[]).push([[127],{690:function(s,a,t){"use strict";t.r(a);var n=t(11),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("rancher2.1版本的功能介绍：https://www.cnrancher.com/docs/rancher/v2.x/cn/overview/feature/")]),s._v(" "),t("h2",{attrs:{id:"_1-准备工作。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-准备工作。"}},[s._v("#")]),s._v(" 1，准备工作。")]),s._v(" "),t("h3",{attrs:{id:"_1-主机准备。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-主机准备。"}},[s._v("#")]),s._v(" 1，主机准备。")]),s._v(" "),t("p",[s._v("本次部署所用机器均为"),t("code",[s._v("CentOS Linux release 7.6.1810 (Core)")]),s._v("。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"center"}},[s._v("节点名称")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("IP")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("安装组件")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("nginx")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.111.6")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("nginx")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("node1")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.111.3")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("etcd, docker, k8s")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("node2")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.111.4")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("etcd, docker, k8s")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("node3")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.111.5")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("etcd, docker, k8s")])])])]),s._v(" "),t("h3",{attrs:{id:"_2-软件准备。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-软件准备。"}},[s._v("#")]),s._v(" 2，软件准备。")]),s._v(" "),t("p",[s._v("因为软件版本可能中有变更，所以我把这次部署的包都放在百度网盘，下载之后部署，以保证部署过程的流畅。")]),s._v(" "),t("ul",[t("li",[s._v("链接: https://pan.baidu.com/s/1sdLPuRTDBbd9UrzyMQCTeA")]),s._v(" "),t("li",[s._v("提取码: "),t("code",[s._v("7ete")])])]),s._v(" "),t("p",[s._v("文中相关部署软件的命令，可做相对应的调整。")]),s._v(" "),t("h3",{attrs:{id:"_3-软件版本。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-软件版本。"}},[s._v("#")]),s._v(" 3，软件版本。")]),s._v(" "),t("ul",[t("li",[s._v("rancher-2.2.2")]),s._v(" "),t("li",[s._v("kubernetes-1.13.5")]),s._v(" "),t("li",[s._v("rke-v0.2.2")]),s._v(" "),t("li",[s._v("kubectl-v1.13.5")]),s._v(" "),t("li",[s._v("helm-v2.13.1")]),s._v(" "),t("li",[s._v("tiller-v2.13.1")])]),s._v(" "),t("h3",{attrs:{id:"_4-架构示意。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-架构示意。"}},[s._v("#")]),s._v(" 4，架构示意。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/5e0d46194436f2c4.jpg",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"_2-初始化环境。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-初始化环境。"}},[s._v("#")]),s._v(" 2，初始化环境。")]),s._v(" "),t("p",[s._v("初始化部分，三台node机器都要操作。")]),s._v(" "),t("h3",{attrs:{id:"_1-关闭相关服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-关闭相关服务"}},[s._v("#")]),s._v(" 1，关闭相关服务")]),s._v(" "),t("ul",[t("li",[s._v("关闭防火墙")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("systemctl stop firewalldsy\nstemctl disable firewalld\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("关闭setlinx")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" setenforce "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" SELINUX /etc/selinux/config\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SELINUX")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("disabled\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("关闭swap")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("swapoff -a "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/ swap / s/^\\(.*\\)$/#\\1/g'")]),s._v(" /etc/fstab\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_2-主机名等设置。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-主机名等设置。"}},[s._v("#")]),s._v(" 2，主机名等设置。")]),s._v(" "),t("ul",[t("li",[s._v("设置永久主机名称，然后重新登录")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" hostnamectl set-hostname node1\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" hostnamectl set-hostname node2\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" hostnamectl set-hostname node3\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("设置的主机名保存在 /etc/hosts 文件中")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/hosts "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n192.168.111.3 node1\n192.168.111.4 node2\n192.168.111.5 node3\nEOF")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"_3-操作系统及kernel调优"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-操作系统及kernel调优"}},[s._v("#")]),s._v(" 3，操作系统及kernel调优")]),s._v(" "),t("ul",[t("li",[s._v("文件打开数调优。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root soft nofile 65535'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("root hard nofile 65535"),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("* soft nofile 65535"),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("* hard nofile 65535"),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v("     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/security/limits.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s#4096#65535#g'")]),s._v(" /etc/security/limits.d/20-nproc.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("kernel调优")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/sysctl.conf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nnet.ipv4.ip_forward=1\nnet.bridge.bridge-nf-call-iptables=1\nnet.bridge.bridge-nf-call-ip6tables=1\nvm.swappiness=0\nvm.max_map_count=655360\nEOF")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"_4-安装一些基础软件。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-安装一些基础软件。"}},[s._v("#")]),s._v(" 4，安装一些基础软件。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("yum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" ntpdate lrzsz "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" yum-utils device-mapper-persistent-data lvm2 bash-completion "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" ntpdate -u cn.pool.ntp.org\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_5-创建用户等"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-创建用户等"}},[s._v("#")]),s._v(" 5，创建用户等")]),s._v(" "),t("ul",[t("li",[s._v("创建用户并且添加到docker组")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("groupadd")]),s._v(" docker\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" rancher -G docker\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"123456"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v(" --stdin rancher\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("这一步非常重要，如果没有操作，则后边可能会有报错等问题。")]),s._v(" "),t("ul",[t("li",[s._v("ssh免密登录")])]),s._v(" "),t("p",[s._v("在"),t("code",[s._v("node1")]),s._v("服务器上执行下面命令：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - rancher\nssh-keygen\nssh-copy-id rancher@192.168.111.3\nssh-copy-id rancher@192.168.111.4\nssh-copy-id rancher@192.168.111.5\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("blockquote",[t("p",[s._v("通过授权node1主机对三台主机的免密码登陆，为后边安装k8s的步骤做好准备工作。")])]),s._v(" "),t("h2",{attrs:{id:"_3-安装docker。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-安装docker。"}},[s._v("#")]),s._v(" 3，安装docker。")]),s._v(" "),t("p",[s._v("需要在三台主机上一起安装docker。")]),s._v(" "),t("p",[t("code",[s._v("rke工具目前只支持docker v17.03.2，请务必保持版本一致，否则后续安装会报错。")])]),s._v(" "),t("ul",[t("li",[s._v("1、安装repo源：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("2，卸载旧docker版本")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("yum remove -y docker "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-client "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-client-latest "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-common "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-latest "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-latest-logrotate "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-logrotate "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-selinux "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-engine-selinux "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              docker-engine "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n              container*\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[s._v("3、安装docker-ce-17.03.2")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("yum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --setopt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("obsoletes"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" docker-ce-17.03.2.ce-1.el7.centos docker-ce-selinux-17.03.2.ce-1.el7.centos\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("4、启动docker")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ systemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" docker\n$ systemctl start docker\n$ systemctl status docker\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("5、添加国内加速代理，设置storage-driver")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/docker/daemon.json "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "registry-mirrors": ["https://7bezldxe.mirror.aliyuncs.com/","https://kw88y6eh.mirror.aliyuncs.com"],\n  "insecure-registries":["192.168.112.69"],\n    "storage-driver": "overlay2",\n    "storage-opts": [\n    "overlay2.override_kernel_check=true"\n    ]\n}\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ul",[t("li",[t("code",[s._v("registry-mirrors")]),s._v("：表示公网的加速器地址，可设置多个，"),t("code",[s._v("地址需要添加协议头(https或者http)")]),s._v("。")]),s._v(" "),t("li",[t("code",[s._v("insecure-registries")]),s._v("：表示内网的私服地址，"),t("code",[s._v("地址不能添加协议头(http)")]),s._v("。")]),s._v(" "),t("li",[t("code",[s._v("storage-driver")]),s._v("：表示使用OverlayFS的overlay2存储驱动。")]),s._v(" "),t("li",[s._v("6、重启docker")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("systemctl daemon-reload\nsystemctl restart docker\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"_4-安装nginx。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-安装nginx。"}},[s._v("#")]),s._v(" 4，安装nginx。")]),s._v(" "),t("p",[s._v("在192.168.111.6服务器上安装nginx，用于rancher-server负载均衡。")]),s._v(" "),t("p",[s._v("安装nginx：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nginx -y\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" nginx.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("修改配置文件：vi /etc/nginx/nginx.conf")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" nginx")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("worker_processes")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("worker_rlimit_nofile")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("events")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("worker_connections")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Gzip Settings")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_disable")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"msie6"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_disable")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"MSIE [1-6]\\.(?!.*SV1)"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_vary")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_proxied")]),s._v(" any")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_min_length")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_comp_level")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_buffers")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8k")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_http_version")]),s._v(" 1.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("gzip_types")]),s._v(" text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml application/font-woff text/javascript application/javascript application/x-javascript text/x-json application/json application/x-web-app-manifest+json text/css text/plain text/x-component font/opentype application/x-font-ttf application/vnd.ms-fontobjectfont/woff2 image/x-icon image/png image/jpeg")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),s._v(" https://"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("stream")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" rancher_servers")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("least_conn")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" 192.168.111.3:443 max_fails=3 fail_timeout=5s")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" 192.168.111.4:443 max_fails=3 fail_timeout=5s")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" 192.168.111.5:443 max_fails=3 fail_timeout=5s")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" rancher_servers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br")])]),t("p",[s._v("启动nginx：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl restart nginx.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"_5-rancher集群部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-rancher集群部署"}},[s._v("#")]),s._v(" 5，Rancher集群部署")]),s._v(" "),t("h3",{attrs:{id:"_1-安装必要工具"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装必要工具"}},[s._v("#")]),s._v(" 1，安装必要工具")]),s._v(" "),t("p",[s._v("以下操作只需在"),t("code",[s._v("192.168.111.3")]),s._v("这一台上操作即可。")]),s._v(" "),t("ul",[t("li",[s._v("安装rke:")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" root\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://www.cnrancher.com/download/rke/rke_linux-amd64\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x rke_linux-amd64\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" rke_linux-amd64 /usr/bin/rke\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("安装kubectl：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://www.cnrancher.com/download/kubectl/kubectl_amd64-linux\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x kubectl_amd64-linux\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" kubectl_amd64-linux /usr/bin/kubectl\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("安装helm：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://www.cnrancher.com/download/helm/helm-linux.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf helm-linux.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" linux-amd64/helm /usr/bin/helm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" linux-amd64/tiller /usr/bin/tiller\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf helm-linux.tar.gz linux-amd64/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("其它工具下载地址：https://www.cnrancher.com/docs/rancher/v2.x/cn/install-prepare/download/")]),s._v(" "),t("h3",{attrs:{id:"_2-安装k8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装k8s"}},[s._v("#")]),s._v(" 2，安装k8s")]),s._v(" "),t("ul",[t("li",[s._v("1、切换到rancher用户")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("su - rancher\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[t("code",[s._v("注意：")]),s._v("必须使用普通用户操作，否则后边的操作会报下边的错：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("Please check "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" the configured user can execute "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("docker "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" on the node, and "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" the SSH server version is at least version "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6.7")]),s._v(" or higher. If youare using RedHat/CentOS, you can't use the user "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" Please refer to the documentation "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" instructions. Error: ssh: rejected: administratively prohibited "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("open failed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("2、创建rancher集群配置文件：")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("cat "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" rancher"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster.yml << EOF\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.111.3\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rancher\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("controlplane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("worker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.111.4\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rancher\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("controlplane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("worker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.111.5\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rancher\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("controlplane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("worker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("etcd")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("snapshot")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creation")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 6h\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("retention")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 24h\nEOF\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("ol",[t("li",[t("code",[s._v("address")]),s._v("：公共域名或IP地址")]),s._v(" "),t("li",[t("code",[s._v("user")]),s._v("：可以运行docker命令的用户，需要是普通用户。")]),s._v(" "),t("li",[t("code",[s._v("role")]),s._v("：分配给节点的Kubernetes角色列表")]),s._v(" "),t("li",[t("code",[s._v("ssh_key_path")]),s._v("：用于对节点进行身份验证的SSH私钥的路径（默认为~/.ssh/id_rsa）")])]),s._v(" "),t("ul",[t("li",[s._v("3、启动集群")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ rke up --config ./rancher-cluster.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("如果这一步报错下边的内容：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" the SSH server version is at least version "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6.7")]),s._v(" or higher. If you are using RedHat/CentOS, you can't use the user "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" Please refer to the documentation "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" instructions\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("则可能是系统的"),t("code",[s._v("openssh")]),s._v("版本太低，只需执行如下命令升级即可：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rancher@localhost ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -V\nOpenSSH_6.6.1p1, OpenSSL "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".1e-fips "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" Feb "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2013")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#低于上边要求的6.7")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rancher@localhost ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ yum -y update openssh\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssh")]),s._v(" -V\nOpenSSH_7.4p1, OpenSSL "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(".2k-fips  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" Jan "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2017")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("然后再切回rancher用户执行安装即可！")]),s._v(" "),t("p",[s._v("完成后，它应显示："),t("code",[s._v("Finished building Kubernetes cluster successfully。")]),s._v("\n并且已经创建了一个文件kube_config_rancher-cluster.yml。这个文件包含kubectl和helm访问K8S的凭据。")]),s._v(" "),t("ul",[t("li",[s._v("4、配置环境变量：")])]),s._v(" "),t("p",[s._v("切换到root用户")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - root\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/profile\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KUBECONFIG")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/rancher/kube_config_rancher-cluster.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("保存，并执行：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /etc/profile\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("保存"),t("code",[s._v("kube_config_rancher-cluster.yml")]),s._v("和"),t("code",[s._v("rancher-cluster.yml")]),s._v("文件的副本,后期维护和升级Rancher实例时将会用到。")]),s._v(" "),t("ul",[t("li",[s._v("5、通过kubectl测试您的连接，并查看您的所有节点是否处于Ready状态")])]),s._v(" "),t("p",[s._v("先配置一下kubectl的命令补全功能。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"source <(kubectl completion bash)"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.bashrc\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" ~/.bashrc\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - rancher\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"source <(kubectl completion bash)"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.bashrc\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" ~/.bashrc\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("然后查看节点状态。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - rancher\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rancher@node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get node\nNAME            STATUS   ROLES                      AGE   VERSION\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.3   Ready    controlplane,etcd,worker   10m   v1.13.5\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.4   Ready    controlplane,etcd,worker   10m   v1.13.5\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".111.5   Ready    controlplane,etcd,worker   10m   v1.13.5\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("由于需要联网下载docker镜像文件，所以需要一段时间才能安装好，10-30分钟左右。")]),s._v(" "),t("ul",[t("li",[s._v("6、检查集群Pod的运行状况")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rancher@node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get pods --all-namespaces\nNAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE\ningress-nginx   default-http-backend-78fccfc5d9-j8v5h     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m45s\ningress-nginx   nginx-ingress-controller-cpb9t            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m16s\ningress-nginx   nginx-ingress-controller-fzcdl            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m16s\ningress-nginx   nginx-ingress-controller-n2f5b            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m36s\nkube-system     canal-9vzxn                               "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m59s\nkube-system     canal-p8t59                               "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m59s\nkube-system     canal-v8nhz                               "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m59s\nkube-system     kube-dns-58bd5b8dd7-dp8nk                 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("/3     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m55s\nkube-system     kube-dns-autoscaler-77bc5fd84-t2jht       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m54s\nkube-system     metrics-server-58bd5dd8d7-pr6nh           "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m50s\nkube-system     rke-ingress-controller-deploy-job-qh82s   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Completed   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m46s\nkube-system     rke-kube-dns-addon-deploy-job-g95sp       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Completed   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m56s\nkube-system     rke-metrics-addon-deploy-job-mmk57        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Completed   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          9m51s\nkube-system     rke-network-plugin-deploy-job-b75ds       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Completed   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          10m\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("保存kube_config_rancher-cluster.yml和rancher-cluster.yml文件的副本,以后将需要这些文件来维护和升级Rancher实例。")]),s._v(" "),t("h3",{attrs:{id:"_3-helm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-helm"}},[s._v("#")]),s._v(" 3，Helm")]),s._v(" "),t("p",[s._v("Helm有两个部分：Helm客户端(helm)和Helm服务端(Tiller)。")]),s._v(" "),t("p",[s._v("使用Helm在集群上安装tiller服务以管理charts，由于RKE默认启用RBAC, 因此我们需要使用kubectl来创建一个serviceaccount，clusterrolebinding才能让tiller具有部署到集群的权限。")]),s._v(" "),t("ul",[t("li",[s._v("1、在kube-system命名空间中创建ServiceAccount：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl -n kube-system create serviceaccount tiller\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("2、创建ClusterRoleBinding以授予tiller帐户对集群的访问权限：")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl create clusterrolebinding tiller --clusterrole cluster-admin --serviceaccount"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-system:tiller\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("3、安装Helm Server(Tiller)")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("helm init --service-account tiller   --tiller-image registry.cn-hangzhou.aliyuncs.com/eryajf/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("4、安装Tiller金丝雀版本")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("helm init --service-account tiller --canary-image\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("需要修改成国内镜像（可能需要delete再重新init）")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl --namespace"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-system "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployments/tiller-deploy "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tiller")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("registry.cn-hangzhou.aliyuncs.com/eryajf/tiller:v2.13.1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_4-helm安装rancher"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-helm安装rancher"}},[s._v("#")]),s._v(" 4，helm安装rancher")]),s._v(" "),t("h4",{attrs:{id:"_1-添加chart仓库地址"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加chart仓库地址"}},[s._v("#")]),s._v(" 1，添加Chart仓库地址")]),s._v(" "),t("p",[s._v("使用helm repo add命令添加Rancher chart仓库地址,访问Rancher tag和Chart版本\n替换为您要使用的Helm仓库分支(即latest或stable）。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("helm repo "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" rancher-stable https://releases.rancher.com/server-charts/stable\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"_2-安装证书管理器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装证书管理器"}},[s._v("#")]),s._v(" 2，安装证书管理器")]),s._v(" "),t("ul",[t("li",[s._v("1、只有Rancher自动生成的证书和LetsEncrypt颁发的证书才需要cert-manager。如果是你自己的证书，可使用ingress.tls.source=secret参数指定证书，并跳过此步骤。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("helm "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" stable/cert-manager "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --name cert-manager "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --namespace kube-system\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("2、Rancher自动生成证书")])]),s._v(" "),t("p",[s._v("默认情况下，Rancher会自动生成CA根证书并使用cert-manager颁发证书以访问Rancher server界面。")]),s._v(" "),t("p",[s._v("唯一的要求是将hostname配置为访问Rancher的域名地址，使用这种SSL证书配置方式需提前安装证书管理器。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("helm "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" rancher-stable/rancher "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --name rancher "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --namespace cattle-system "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("hostname")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rancher.com\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("rancher.com就是后面访问rancher的域名，需要在/etc/hosts文件中添加关联（所有主机）：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.111.6 rancher.com"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node2 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.111.6 rancher.com"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@node3 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.111.6 rancher.com"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nginx ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.111.6 rancher.com"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("由于我们通过hosts文件来添加映射，所以需要为Agent Pod添加主机别名(/etc/hosts)：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl -n cattle-system patch  deployments cattle-cluster-agent --patch "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n    "spec": {\n        "template": {\n            "spec": {\n                "hostAliases": [\n                    {\n                        "hostnames":\n                        [\n                            "rancher.com"\n                        ],\n                            "ip": "192.168.111.6"\n                    }\n                ]\n            }\n        }\n    }\n}\'')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("这一步如果马上执行，可能会报错："),t("code",[s._v('Error from server (NotFound): deployments.extensions "cattle-cluster-agent" not found')]),s._v("，这个deployment是上一步install时创建的，比较慢，耐心等待一下，这个时候也可以先跳过这里，去到后边，简单配置一下，访问一下rancher的界面。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("kubectl -n cattle-system patch  daemonsets cattle-node-agent --patch "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n    "spec": {\n        "template": {\n            "spec": {\n                "hostAliases": [\n                    {\n                        "hostnames":\n                        [\n                            "rancher.com"\n                        ],\n                            "ip": "192.168.111.6"\n                    }\n                ]\n            }\n        }\n    }\n}\'')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"_5-登录rancher管理端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-登录rancher管理端"}},[s._v("#")]),s._v(" 5，登录rancher管理端")]),s._v(" "),t("ul",[t("li",[s._v("1、同样将刚刚的域名映射关系写入到Windows主机的hosts文件。")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("192.168.111.6 rancher.com\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[t("p",[s._v("2、使用域名访问https://rancher.com")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/a872dafdd0233f17.jpg",alt:""}})])])]),s._v(" "),t("p",[s._v("输入：admin/admin，进入首页界面。")]),s._v(" "),t("p",[s._v("刚进入，会看到一个问题。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/3de5d924ed4c9472.jpg",alt:""}})]),s._v(" "),t("p",[s._v("报这个问题的原因就是刚刚创建的"),t("code",[s._v("cattle-cluster-agent")]),s._v("还没有被创建成功，同样耐心等待即可。这个时候可以随便点点看看先。这个过程与自己的网络有关，这时也可以在node1主机上，通过如下命令进行一个监控。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("rancher@node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ kubectl get -n cattle-system pod -w\nNAME                     READY   STATUS    RESTARTS   AGE\nrancher-bdf49fb9-7qhgp   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          12m\nrancher-bdf49fb9-hf6tm   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          12m\nrancher-bdf49fb9-xmbv7   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          12m\ncattle-cluster-agent-7b54db4bc8-r4blg   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   Pending   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-cluster-agent-7b54db4bc8-r4blg   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   Pending   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-cluster-agent-7b54db4bc8-r4blg   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-node-agent-mskmb   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   Pending   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-node-agent-2cmww   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   Pending   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-node-agent-kkpvn   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   Pending   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-node-agent-mskmb   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-node-agent-kkpvn   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\ncattle-node-agent-2cmww   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1   ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     0s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("在我这里，等了十分钟左右，才开始正式的部署。这个时候，可以返回到上边，将那两条命令导入进去。")]),s._v(" "),t("p",[s._v("操作之后，然后再看rancher，就不会报连接问题了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/51f18fab18d54ec0.jpg",alt:""}})]),s._v(" "),t("p",[s._v("到这里，基本上安装步骤也就完成了，可以随便点点看看界面里边的各项功能什么的。")]),s._v(" "),t("p",[s._v("最后再来个整体界面的定妆照：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/c5aa1b2f9a582062.jpg",alt:""}})])])}),[],!1,null,null,null);a.default=e.exports}}]);